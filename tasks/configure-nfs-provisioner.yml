- name: Create NFS export directory
  file:
    path: /export
    state: directory
    mode: 0777
    owner: nfsnobody
    group: nfsnobody
  notify:
    - restart nfs

- name: Copy NFS export conf file
  copy:
    src: ../files/nfs-exports
    dest: /etc/exports
  notify:
    - restart nfs

- name: Copying over nfs-provisioner rbac
  copy:
    src: ../files/nfs-provisioner-rbac.yaml
    dest: /usr/local/src/nfs-provisioner-rbac.yaml
    owner: root
    group: root
    mode: 0666

- name: Copying over nfs-provisioner deployment
  template:
    src: ../templates/nfs-provisioner-deployment.yaml.j2
    dest: /usr/local/src/nfs-provisioner-deployment.yaml
    owner: root
    group: root
    mode: 0666

- name: Copying over nfs-provisioner storageclass
  copy:
    src: ../files/nfs-provisioner-sc.yaml
    dest: /usr/local/src/nfs-provisioner-sc.yaml
    owner: root
    group: root
    mode: 0666

- name: Copying over nfs-provisioner setup script
  copy:
    src: ../files/nfs-provisioner-setup.sh
    dest: /usr/local/bin/nfs-provisioner-setup.sh
    owner: root
    group: root
    mode: 0555

- name: Copying over a sample PVC file for NFS
  copy:
    src: ../files/registry-pvc.yaml
    dest: /usr/local/src/registry-pvc.yaml
    mode: '0555'

- name: Open up firewall for nfs server
  firewalld:
    permanent: yes
    immediate: yes
    state: enabled
    port: "{{ item }}"
  with_items:
    - 111/tcp
    - 2049/tcp
    - 20048/tcp
    - 50825/tcp
    - 53248/tcp
